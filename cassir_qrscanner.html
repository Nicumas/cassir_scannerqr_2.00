<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      position: fixed;
    }
    #videoContainer {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã */
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      text-align: center;
      padding: 20px 0;
      background: rgba(0,0,0,0.7);
    }
    #msg {
      font-size: 1.2em;
      padding: 10px;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 1.2em;
      background: #31a952;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    #error {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #ff4444;
      font-weight: bold;
      z-index: 30;
      display: none;
      padding: 10px;
      background: rgba(0,0,0,0.7);
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="videoContainer">
    <button id="startButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    <video id="video" autoplay muted playsinline class="hidden"></video>
    <div id="overlay" class="hidden">
      <div id="msg">üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</div>
    </div>
    <div id="error"></div>
  </div>

  <script>
    const video = document.getElementById('video');
    const msg = document.getElementById('msg');
    const startButton = document.getElementById('startButton');
    const overlay = document.getElementById('overlay');
    const errorEl = document.getElementById('error');
    let scanActive = false;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∞–º–µ—Ä—ã
    function checkCameraSupport() {
      return !!(
        navigator.mediaDevices && 
        navigator.mediaDevices.getUserMedia &&
        window.MediaStream
      );
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      console.error(message);
    }

    // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
    async function startCamera() {
      if (!checkCameraSupport()) {
        showError('–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
        return;
      }
      
      try {
        const constraints = {
          video: { 
            facingMode: "environment",
            width: { min: 640, ideal: 1280 },
            height: { min: 480, ideal: 720 }
          }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        video.classList.remove('hidden');
        overlay.classList.remove('hidden');
        startButton.classList.add('hidden');
        errorEl.style.display = 'none';
        
        video.onloadedmetadata = () => {
          scanActive = true;
          requestAnimationFrame(scanFrame);
        };
        
      } catch (err) {
        let errorMessage = 'üö´ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
        
        if (err.name === 'NotAllowedError') {
          errorMessage = '‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
        } else if (err.name === 'NotFoundError') {
          errorMessage = '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
        } else if (err.name === 'OverconstrainedError') {
          errorMessage = '‚ùå –¢—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è';
        }
        
        showError(errorMessage);
        startButton.classList.remove('hidden');
      }
    }

    // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–æ–≤
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');

    function scanFrame() {
      if (!scanActive) return;
      
      try {
        if (video.readyState >= video.HAVE_METADATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imgData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imgData.data, canvas.width, canvas.height);
          
          if (code) {
            try {
              const payload = JSON.parse(code.data);
              if (payload.type === "client" && payload.uid) {
                msg.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω –∫–ª–∏–µ–Ω—Ç: UID ${payload.uid}`;
                scanActive = false;
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
                if (window.Telegram && Telegram.WebApp) {
                  Telegram.WebApp.sendData(JSON.stringify(payload));
                }
                return;
              } else {
                msg.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥';
              }
            } catch (e) {
              msg.textContent = '‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö QR';
            }
          }
        }
        requestAnimationFrame(scanFrame);
      } catch (e) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + e.message);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    startButton.addEventListener('click', startCamera);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('DOMContentLoaded', () => {
      // –î–ª—è Telegram WebApp –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        startCamera();
      } else {
        startButton.classList.remove('hidden');
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
      if (!checkCameraSupport()) {
        showError('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
        startButton.disabled = true;
      }
    });

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
    });
  </script>
</body>
</html>